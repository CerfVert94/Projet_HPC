/* -------------- */
/* --- main.c --- */
/* -------------- */

#include <stdio.h>
#include <stdlib.h>


#include "nrdef.h"
#include "nrutil.h"
#include "img.h"
#include "mouvement.h"
#include <stdbool.h>
#include <morpho.h>
//#include "mymacro.h"
//#include "test_simd1.h"
#include <test_mouvement.h>
#include <test_morpho.h>
#include <util.h>

// ============
void info(void)
// ============
{
#ifdef ENABLE_BENCHMARK
    puts("#############################");
    puts("mode Benchmark ON & DEBUG OFF");
    puts("#############################");
#else
    puts("#############################");
    puts("mode Benchmark OFF & DEBUG ON");
    puts("#############################");
#endif
}

void launch_benchmark(const char *filename, struct morpho_set *msets, const int nb_sets, long min_size, long max_size) {
    FILE *file;
    
    double **results;
    long step = 1, nb_tests = 10, k = 0;
    
    results = benchmark(msets, nb_sets, min_size, max_size, step, nb_tests);

    file = fopen(filename, "w");
    if (!file)
        exit_on_error("fopen failed");
    k = 0;
    fprintf(file, "#%*s", 4, "Size");
    for (long i = 0; i < nb_sets; i++) {
        fprintf(file, RALIGNED_STR, msets[i].func_name);
    }
    fputc('\n', file);
    for (long size = min_size; size < max_size + 1; size += step) {
        fprintf(file, "%*ld", 4, size);
        for (long i = 0; i < nb_sets; i++) {
            fprintf(file, RALIGNED_DOUBLE, results[i][k]);
        }
        fprintf(file, "\n");
        k++;
    }
    free_benchmark_results(results, 1);
    fclose(file);
}
void movement_detection()
{
    char filename[128];
    p_struct_elem_dim s = compute_struct_elem_dim(1,1,3,3);
    int idx = 3000;
    for (int i = 0; i < 200 - 1; i++) 
    {
	    sprintf(filename, "../car3/car_%d.pgm", idx + i);
        printf("../car3/car_%d.pgm\n", idx + i);
        p_image t_1 = create_image(filename);
	    sprintf(filename, "../car3/car_%d.pgm", idx + i + 1);
	    p_image t = create_image(filename);
        SigmaDelta_step0(t);
        SigmaDelta_step0(t_1);
        SigmaDelta(t, t_1);
	    sprintf(filename, "../md/car_%d.pgm", idx + i + 1);
        // ui8matrix_sequence_LU3x3(t->E, t->nrl + BORD, t->nrh - BORD, t->ncl + BORD, t->nch - BORD, s, t->Omega);
        binary_to_octal_ui8matrix(t->Omega, t->nrl + BORD, t->nrh - BORD, t->ncl + BORD, t->nch - BORD);
        SavePGM_ui8matrix(t->Omega, t->nrl + BORD, t->nrh - BORD, t->ncl + BORD, t->nch - BORD, filename);
        free_image(t);
        free_image(t_1);        
    }
    //info();
    free_structuring_element(s);
}
void test_dilations(struct morpho_set *dilation_sets, const int nb_implementations)
{
    const long start_x = 300, start_y = 200, end_x=340, end_y=240;
    long x = 0, y = 0, nrl, nrh, ncl, nch;
    uint8 **image, **X, **correct_output;
    char filename[128];
    for (int i = 0; i < nb_implementations; i++) {
        if (dilation_sets[i].s->ncol == 3) {
            test_implementation_dilation_3x3(&dilation_sets[i]);
        }
        else {//if (dilation_sets[i].s == s5)
            // test_implementation_dilation_5x5(&dilation_sets[i]);
            // test_integration_dilation_5x5(&dilation_sets[i]);
        }
    }

    
    for(x = start_x; x < end_x + 1; x++){
        for(y = start_y; y < end_y + 1; y++){
            snprintf(filename, 128, "testcases/car{%ld}{%ld}.pgm",x,y);
            
            image = LoadPGM_ui8matrix(filename, &nrl, &nrh, &ncl, &nch);

            X = ui8matrix(nrl + dilation_sets[0].s->nrl, nrh + dilation_sets[0].s->nrh, ncl + dilation_sets[0].s->ncl, nch + dilation_sets[0].s->nch);
            memset_ui8matrix(X, 0, nrl + dilation_sets[0].s->nrl, nrh + dilation_sets[0].s->nrh, ncl + dilation_sets[0].s->ncl, nch + dilation_sets[0].s->nch);
            copy_ui8matrix_ui8matrix(image, nrl, nrh, ncl, nch, X);
            correct_output = ui8matrix(nrl + dilation_sets[0].s->nrl, nrh + dilation_sets[0].s->nrh, ncl + dilation_sets[0].s->ncl, nch + dilation_sets[0].s->nch);
            memset_ui8matrix(correct_output, 0, nrl + dilation_sets[0].s->nrl, nrh + dilation_sets[0].s->nrh, ncl + dilation_sets[0].s->ncl, nch + dilation_sets[0].s->nch);
            
            ui8matrix_dilation_naive(X, nrl, nrh, ncl, nch, dilation_sets[0].s, correct_output);
            for (int i = 0; i < nb_implementations; i++) {
                printf("Integration test : %s (%30s)\n", dilation_sets[i].func_name, filename);
                test_integration_morpho_3x3(&dilation_sets[i], X, nrl, nrh, ncl, nch, correct_output);
	            printf("\tTest passed\n");
            }
                
            free_ui8matrix(image,nrl, nrh, ncl, nch);
            free_ui8matrix(X, nrl + dilation_sets[0].s->nrl, nrh + dilation_sets[0].s->nrh, ncl + dilation_sets[0].s->ncl, nch + dilation_sets[0].s->nch);
            free_ui8matrix(correct_output,nrl + dilation_sets[0].s->nrl, nrh + dilation_sets[0].s->nrh, ncl + dilation_sets[0].s->ncl, nch + dilation_sets[0].s->nch);
        }
    }
}
void test_erosions(struct morpho_set *erosion_sets, const int nb_implementations)
{
    for (int i = 0; i < nb_implementations; i++) {
        if (erosion_sets[i].s->ncol == 3) {
            test_implementation_erosion_3x3(&erosion_sets[i]);
            // test_integration_erosion_3x3_r1(&erosion_sets[i]);
            // test_integration_erosion_3x3_r2(&erosion_sets[i]);
            // test_integration_erosion_3x3(&erosion_sets[i]);
        }
        else {//if (erosion_sets[i].s == s5)
            // test_implementation_erosion_5x5(&erosion_sets[i]);
            // test_integration_erosion_5x5(&erosion_sets[i]);
        }
    }
}

void make_testsets(){
    p_struct_elem_dim s5 = compute_struct_elem_dim(2,2,5,5);
    p_struct_elem_dim s3 = compute_struct_elem_dim(1,1,3,3);
    long nrl, nrh, ncl, nch, bord, x, y;
    long size  = 500, noise_size = size;
    bord = 2;
    uint8** image = LoadPGM_ui8matrix("bwimg_r1.pgm", &nrl, &nrh, &ncl, &nch);
    uint8** ppInput  = ui8matrix(nrl - bord, nrh + bord, ncl - bord, nch + bord);
    uint8** ppOutput = ui8matrix(nrl - bord, nrh + bord, ncl - bord, nch + bord);
    memset_ui8matrix(ppInput, 0, nrl - bord, nrh + bord, ncl - bord, nch + bord);
    memset_ui8matrix(ppOutput, 0, nrl - bord, nrh + bord, ncl - bord, nch + bord);

    // copy_ui8matrix_ui8matrix(image, nrl, nrh, ncl, nch, ppInput);
    // octal_to_binary_ui8matrix(ppInput, nrl, nrh, ncl, nch);
    // display_ui8matrix(ppInput, nrl - bord, nrh + bord, ncl - bord, nch + bord, "%u,", "uint8 morpho5x5_test_input[] = {\\");
    // printf("};");

    // ui8matrix_erosion_naive(ppInput, nrl, nrh, ncl, nch, s5, ppOutput);
    // display_ui8matrix(ppOutput,  nrl - bord, nrh + bord, ncl - bord, nch + bord, "%u,", "uint8 erosion5x5_test_output[] = {\\");
    // printf("};");
    // // getchar();
    // ui8matrix_dilation_naive(ppInput, nrl, nrh, ncl, nch, s5, ppOutput);
    // display_ui8matrix(ppOutput,  nrl - bord, nrh + bord, ncl - bord, nch + bord, "%u,", "uint8 dilation5x5_test_output[] = {\\");
    // printf("};");
    // free_ui8matrix(ppInput, nrl - bord, nrh + bord, ncl - bord, nch + bord);
    // free_ui8matrix(ppOutput, nrl - bord, nrh + bord, ncl - bord, nch + bord);
    
    bord = 1;
    ppInput  = ui8matrix(nrl - bord, nrh + bord, ncl - bord, nch + bord);
    ppOutput = ui8matrix(nrl - bord, nrh + bord, ncl - bord, nch + bord);
    memset_ui8matrix(ppInput, 0, nrl - bord, nrh + bord, ncl - bord, nch + bord);
    memset_ui8matrix(ppOutput, 0, nrl - bord, nrh + bord, ncl - bord, nch + bord);

    copy_ui8matrix_ui8matrix(image, nrl, nrh, ncl, nch, ppInput);
    // octal_to_binary_ui8matrix(ppInput, nrl, nrh, ncl, nch);
    display_ui8matrix(ppInput, nrl - bord, nrh + bord, ncl - bord, nch + bord, "%u,", "uint8 morpho3x3_r2_test_input[] = {\\");
    printf("};\n");

    ui8matrix_erosion_naive(ppInput, nrl, nrh, ncl, nch, s3, ppOutput);
    display_ui8matrix(ppOutput,  nrl - bord, nrh + bord, ncl - bord, nch + bord, "%u,", "uint8 erosion3x3_r2_test_output[] = {\\");
    printf("};\n");
    // getchar();
    ui8matrix_dilation_naive(ppInput, nrl, nrh, ncl, nch, s3, ppOutput);
    display_ui8matrix(ppOutput,  nrl - bord, nrh + bord, ncl - bord, nch + bord, "%u,", "uint8 dilation3x3_r2_test_output[] = {\\");
    printf("};\n");
    free_ui8matrix(ppInput, nrl - bord, nrh + bord, ncl - bord, nch + bord);
    free_ui8matrix(ppOutput, nrl - bord, nrh + bord, ncl - bord, nch + bord);
    free_structuring_element(s3);
    free_structuring_element(s5);
}
// -----------
int main(void)
// -----------
{
    p_struct_elem_dim s5 = compute_struct_elem_dim(2,2,5,5);
    p_struct_elem_dim s3 = compute_struct_elem_dim(1,1,3,3);
    long nb_sets = 4;

    
    
    
    struct morpho_set dilation_sets[] = {
                                        //  {.func_name = "ui8matrix_dilation_naive"                   , .morpho_func = ui8matrix_dilation_naive          , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O1xO1"             , .morpho_func = ui8matrix_dilation_LU3x3_O1xO1    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O3xO1_ver1"        , .morpho_func = ui8matrix_dilation_LU3x3_O3xO1_ver1    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O3xO1_ver2"        , .morpho_func = ui8matrix_dilation_LU3x3_O3xO1    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O3xO1_RR_ver1"     , .morpho_func = ui8matrix_dilation_LU3x3_O3xO1_RR_ver1 , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O3xO1_RR_ver2"     , .morpho_func = ui8matrix_dilation_LU3x3_O3xO1_RR , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O1xO3_RR_ver1"     , .morpho_func = ui8matrix_dilation_LU3x3_O1xO3_RR_ver1    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O1xO3_RR_ver2"     , .morpho_func = ui8matrix_dilation_LU3x3_O1xO3_RR_ver2    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O1xO3_RR_ver3"     , .morpho_func = ui8matrix_dilation_LU3x3_O1xO3_RR_ver3    , .s = s3},
                                         {.func_name = "ui8matrix_dilation_LU3x3_O1xO3_RR"          , .morpho_func = ui8matrix_dilation_LU3x3_O1xO3_RR    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O1xO3_PJ"          , .morpho_func = ui8matrix_dilation_LU3x3_O1xO3_PJ    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O1xO3_ver1"        , .morpho_func = ui8matrix_dilation_LU3x3_O1xO3_ver1    , .s = s3},
                                         {.func_name = "ui8matrix_dilation_LU3x3_O1xO3"             , .morpho_func = ui8matrix_dilation_LU3x3_O1xO3         , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O3xO3_ver1"        , .morpho_func = ui8matrix_dilation_LU3x3_O3xO3_ver1    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O3xO3_ver2"        , .morpho_func = ui8matrix_dilation_LU3x3_O3xO3    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_LU3x3_O3xO3_RR_ver1"     , .morpho_func = ui8matrix_dilation_LU3x3_O3xO3_RR_ver1    , .s = s3},
                                         {.func_name = "ui8matrix_dilation_LU3x3_O3xO3_RR"          , .morpho_func = ui8matrix_dilation_LU3x3_O3xO3_RR    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_pipeline3x3"             , .morpho_func = ui8matrix_dilation_pipeline3x3          , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_pipeline_LU3x3_O3xO1"    , .morpho_func = ui8matrix_dilation_pipeline_LU3x3_O3xO1    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_pipeline_LU3x3_O3xO1_RR" , .morpho_func = ui8matrix_dilation_pipeline_LU3x3_O3xO1_RR    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_pipeline_LU3x3_O1xO3"    , .morpho_func = ui8matrix_dilation_pipeline_LU3x3_O1xO3    , .s = s3},
                                        //  {.func_name = "ui8matrix_dilation_pipeline_LU3x3_O1xO3_PJ" , .morpho_func = ui8matrix_dilation_pipeline_LU3x3_O1xO3_PJ    , .s = s3},
                                         {.func_name = "ui8matrix_dilation_pipeline_LU3x3_O1xO3_RR" , .morpho_func = ui8matrix_dilation_pipeline_LU3x3_O1xO3_RR    , .s = s3},
                                        };

    // ui8matrix_dilation_LU3x3_O1xO3_RR;
    // ui8matrix_dilation_LU3x3_O1xO3_ver2;
    // ui8matrix_dilation_LU3x3_O3xO3_RR;
    // ui8matrix_dilation_pipeline_LU3x3_O1xO3_RR;
    /*
    ui8matrix_dilation_LU3x3_O1xO3_RR_ver4 :
        Avg :  1.7846821392532795
        Min :  1.34
        Max :  8.72
    ui8matrix_dilation_LU3x3_O1xO3_ver2 :
        Avg :  2.315307769929364
        Min :  1.79
        Max :  9.9
    ui8matrix_dilation_LU3x3_O3xO3_RR_ver1 :
        Avg :  2.2552169525731585
        Min :  2.07
        Max :  5.28
    ui8matrix_dilation_pipeline_LU3x3_O1xO3_RR :
        Avg :  2.2591019172552973
        Min :  2.06
        Max :  5.55
    */
    nb_sets = 4;
    
    test_dilations(dilation_sets, nb_sets);
    launch_benchmark("output/benchmark_dilation.dat", dilation_sets, nb_sets, 10, 4000);
    // make_testsets();
    free_structuring_element(s3);
    free_structuring_element(s5);

    return 0;    
}